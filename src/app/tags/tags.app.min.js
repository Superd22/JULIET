var services=services||angular.module("services",[]);var Tags=angular.module("Tags",["ui.router","angularUtils.directives.dirPagination","ui.select","services"]);Tags.service("TagCommon",["$http",function(b){var a={};a.isLad=false;a.generateUrl=function(d,f){f=GLOBAL_URL_PATH_TO_JU||"";var c=d.type;if(c==0||c==-1){c="tag"}var e="";if(a.isLad){e="?page=Tags"}return f+e+"#/view/"+c+"/"+encodeURIComponent(d.name)};a.isAutoType=function(c){if(c){return(c.type!=0&&c.type!=1)}};a.has_admin=function(c){var d=b.post(GLOBAL_URL_PATH_TO_JU+"Rights/index.php",{right:"USER_CAN_ADMIN_TAGS",test:"lol",user:c}).then(function(e){var f=false;if(e.data=="1"||e.data=="true"){f=true}return f});return d};a.sendQuery=function(c){var d=b.post(GLOBAL_URL_PATH_TO_JU+"Tags/tags_resolveQuery.php",{query:c}).then(function(e){return e.data});return d};a.getName=function(e,c){var d=b.post(GLOBAL_URL_PATH_TO_JU+"Tags/tags_getNameById.php",{id:e,type:c}).then(function(f){return f.data});return d};return a}]);Tags.controller("controller.tags",function(c,h,g,b){c.BaseUrl=GLOBAL_URL_PATH_TO_JU;var e=false;var a=false;var d;function f(){return"Voir"}c.getTags=function(i){c.isasync=true;if(!i&&Array.isArray(c.tags)){}else{h.get(GLOBAL_URL_PATH_TO_JU+"Tags/tags_get.php").success(function(j){c.tags=j}).then(function(){c.isasync=false})}};c.generateUrl=b.generateUrl;c.isAutoType=b.isAutoType;c.shouldShowCreating=false;c.get_current_mod_slang=f;c.isasync=a;c.tagid=g.tagid||c.initTag;c.cat=g.cat||c.initCat;c.userid=g.userID});Tags.controller("controller.tags.single",function(a,c,b){a.tagid=b.tagid||a.initTag;a.cat=b.cat||a.initCat;a.text={};toggleTextP="Sont affichés tous les possesseurs d'un vaisseau de la famille.";toggleTextC="Sont affichés uniquement les possesseurs du vaisseau parent.";a.text.toggleText=toggleTextP;a.get_current_tag=function(f,d){a.isasync=true;var e={category:d,name:f};c.post(GLOBAL_URL_PATH_TO_JU+"Tags/tags_get_single.php",e).success(function(g){a.currentTag=g;a.currentTag.list=a.currentTag.count}).then(function(){a.isasync=false})};a.isAShip=function(d){return d=="ship"};a.toggleParentMod=function(){a.text.toggleText=a.text.toggleText==toggleTextP?toggleTextC:toggleTextP;a.currentTag.list=a.text.toggleText==toggleTextP?a.currentTag.count:a.currentTag.OWN_count}});Tags.controller("controller.tags.owner",function(b,d,c,a){b.userid=b.ladid||c.userID||1;if(b.ladid){a.isLad=true}b.isAShip=function(e){return e=="ship"};b.remove=function(e){b.isasync=true;var f=b.tags.indexOf(e);if(f>-1){b.tags.splice(f,1)}d.post(GLOBAL_URL_PATH_TO_JU+"Tags/tags_post.php",{method:"remove_af",tag_id:e.id,user:b.userid}).success(function(g){}).then(function(){b.getTagsUser(b.userid);b.isasync=false})};b.selecNewTag=function(e){b.newTag.title=e;b.showResult=false;b.tagR=[]};b.isAutoType=a.isAutoType;b.getTagsUser=function(e,f){b.isasync=true;d.post(GLOBAL_URL_PATH_TO_JU+"API/get_users_by_id.php",{user:e}).success(function(g){b.currentUsername=g.split('"').join("")});d.post(GLOBAL_URL_PATH_TO_JU+"Tags/tags_get.php",{user:e}).success(function(g){if(g=="null"){g=[];b.hasnotags=true}else{b.hasnotags=false}b.tags=g}).then(function(){d.get(GLOBAL_URL_PATH_TO_JU+"Tags/tags_get.php").then(function(g){b.rtags=g});b.isasync=false})};b.createTag=function(f,e){if(f.title){f.method="new";if(e){f.user=e}f.name=f.title;if(angular.isArray(b.tags)){b.tags.unshift(f)}b.isasync=true;d.post(GLOBAL_URL_PATH_TO_JU+"Tags/tags_post.php",f).success(function(g){b.newTagProcess=g}).then(function(){b.getTagsUser(e);b.newTag=[];b.isasync=false})}};b.refreshTs=function(e){var f={f:e};b.showResult=true;return d.get(GLOBAL_URL_PATH_TO_JU+"Tags/tags_search.php",{params:f}).then(function(g){b.tagR=g.data;if(!angular.isArray(b.tagR)){b.showResult=false}else{if(b.tagR[0]&&b.tagR[0].name==b.newTag.title){b.showResult=false}}return g.data})};b.has_the_rights=a.has_admin(b.userid);b.generateUrl=a.generateUrl;b.$watch("newTag.title",function(e){b.refreshTs(e)})});Tags.controller("controller.tags.search",function(c,h,g,b,e,a){var d=0;c.models={};c.models.displayShips=1;c.models.displayUsers=1;c.models.queryWrite=[];c.showBbcode=false;c.canEdit=typeof c.initQuery!="undefined"?false:true;c.SYMBOLS=[{name:"(",type:"SYMBOL",symbol:"(",id:1},{name:")",type:"SYMBOL",symbol:")",id:2},{name:"[",type:"SYMBOL",symbol:"(",id:1},{name:"]",type:"SYMBOL",symbol:")",id:2},{name:"AND",type:"SYMBOL",symbol:"AND",id:3},{name:"&&",type:"SYMBOL",symbol:"AND",id:3},{name:"ET",type:"SYMBOL",symbol:"AND",id:3},{name:",",type:"SYMBOL",symbol:"AND",id:3},{name:"OR",type:"SYMBOL",symbol:"OR",id:4},{name:"OU",type:"SYMBOL",symbol:"OR",id:4},{name:"||",type:"SYMBOL",symbol:"OR",id:4},{name:"!",type:"SYMBOL",symbol:"!",id:5},{name:"PAS",type:"SYMBOL",symbol:"!",id:5},{name:"NON",type:"SYMBOL",symbol:"!",id:5},{name:"TS",type:"SPECIAL",symbol:"ONLINE_TS",id:6},{name:"SUR TS",type:"SPECIAL",symbol:"ONLINE_TS",id:6},{name:"ONLINE TS",type:"SPECIAL",symbol:"ONLINE_TS",id:6},{name:"ONLINE_TS",type:"SPECIAL",symbol:"ONLINE_TS",id:6},];symbolMap={};angular.forEach(c.SYMBOLS,function(i){symbolMap[i.id]=i.symbol});c.d={FORCECLEAR:false};encodeUrlM=function(i){var j="";if(i.type=="SYMBOL"){j+="#"}else{if(i.type==0){j+="T"}else{if(i.type==1){j+="R"}else{if(i.type==2){j+="S"}else{if(i.type=="SPECIAL"){j+="!"}}}}}j+=i.id+"$";return j};decodeUrl=function(j){var l=a.defer();c.models.displayUsers=Number(j.substr(0,1));c.models.displayShips=Number(j.substr(1,1));j=j.substr(2);var i=j.split("$");var k=[];var m=[];angular.forEach(i,function(n){var r="SYMBOL";var q="";var s="";var o="";if(n.indexOf("T")===0){r="0"}else{if(n.indexOf("R")===0){r="1"}else{if(n.indexOf("S")===0){r="2"}else{if(n.indexOf("!")===0){r="SPECIAL"}}}}var u=n.substr(1);if(r=="SYMBOL"||r=="SPECIAL"){q=symbolMap[u];s:symbolMap[u]}else{var t=b.getName(u,r).then(function(p){return{name:p.name,img:p.img,type:r,id:u}})}if(t){k.push(t);m.push(t)}else{if(u!=""){k.push({type:r,id:u,name:q,img:o,symbol:q})}}});a.all(m).then(function(n){angular.forEach(k,function(o,p){if(o&&angular.isFunction(o.then)){k[p]=n[0];n.splice(0,1)}});c.models.query=k;return k});return l};c.refreshTags=function(i){c.d.FORCECLEAR=false;var j=false;angular.forEach(c.SYMBOLS,function(m,l){if(i==m.name){m.qId=l;j=true;c.models.query=c.models.query||[];c.models.query.push(m);c.d.FORCECLEAR=true;l++}});if(!j){var k={f:i,mod:"ALL"};return h.get(GLOBAL_URL_PATH_TO_JU+"Tags/tags_search.php",{params:k}).then(function(l){data=l.data==null?[]:l.data;c.models.queryWrite=data;return l.data})}};c.toggleShips=function(){c.models.displayShips=c.models.displayShips==0?1:0};c.toggleUsers=function(){c.models.displayUsers=c.models.displayUsers==0?1:0};c.ownerUrl=function(i){return GLOBAL_URL_PATH_TO_JU+"?page=user&id="+i};c.shipUrl=function(i){return GLOBAL_URL_PATH_TO_JU+"?page=Ships#/view/"+i.owner+"/"+i.id};c.tagUrl=function(i){return GLOBAL_URL_PATH_TO_JU+"?page=Tags#/user/"+i};var f=c.initQuery||g.sQuery;if(f){decodeUrl(f)}c.$watch("models.query",function(i){if(c.canEdit||f){b.sendQuery(i).then(function(j){c.models.result=j;f=false})}});c.$watchGroup(["models.query","models.displayUsers","models.displayShips"],function(k,i){if(c.canEdit){var j="";j+=c.models.displayUsers;j+=c.models.displayShips;angular.forEach(k[0],function(l){j+=encodeUrlM(l)});c.models.bbcode="[JU_TAG_RECHERCHE "+j+"]";e.go("Tags.search",{sQuery:j},{notify:false,reload:false,location:"replace",inherit:true})}})});Tags.config(function(b,a){b.state("Tags",{url:"/",views:{"Tags@":{controller:"controller.tags",templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_main.tmpl.html"},"TagIncluded@":{controller:"controller.tags.owner",templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_user.tmpl.html"},"TagSingleIncluded@":{controller:"controller.tags.single",templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_single.tmpl.html"},"TagsRechercheIncluded@":{controller:"controller.tags.search",templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_search.tmpl.html"},"TagsTabs@":{templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_tabs.tmpl.html"}}}).state("Tags.single",{url:"view/:cat/:tagid",views:{"Tags@":{controller:"controller.tags.single",templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_single.tmpl.html"}}}).state("Tags.user",{url:"user/:userID",views:{"Tags@":{controller:"controller.tags.owner",templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_user.tmpl.html"}}}).state("Tags.ship",{url:"ship/:shipID",views:{"Tags@":{controller:"controller.tags.owner",templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_user.tmpl.html"}}}).state("Tags.search",{url:"search/:sQuery",views:{"Tags@":{controller:"controller.tags.search",templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_search.tmpl.html"},"TagsTabs@":{templateUrl:GLOBAL_URL_PATH_TO_JU+"Tags/templates/tags_tabs.tmpl.html"}}});a.otherwise("/")});